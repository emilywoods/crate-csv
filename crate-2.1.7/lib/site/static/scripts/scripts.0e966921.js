"use strict";var MODULES=["ngRoute","ngCookies","utils","sql","stats","common","overview","feed","console","tables","cluster","tableinfo","shardinfo","nodeinfo","checks","udc","translation","datatypechecks","nvd3","pascalprecht.translate","oc.lazyLoad","ngclipboard"],DEFAULT_PLUGINS=[],ENTERPRISE_PLUGINS=[],ROUTING={"/":{templateUrl:"static/views/overview.html",controller:"OverviewController"},"/console":{templateUrl:"static/views/console.html",controller:"ConsoleController"},"/tables":{templateUrl:"static/views/tables.html",controller:"TableDetailController"},"/tables/:table_schema/:table_name":{templateUrl:"static/views/tables.html",controller:"TableDetailController"},"/nodes":{templateUrl:"static/views/node.html",controller:"NodeDetailController"},"/nodes/:node_id":{templateUrl:"static/views/node.html",controller:"NodeDetailController"}},app=angular.module("crate",MODULES),head=document.getElementsByTagName("head")[0],loadScript=function(url){var result=$.Deferred(),script=document.createElement("script");return script.async="async",script.type="text/javascript",script.src=url,script.onload=function(){result.resolve()},script.onerror=function(){result.reject()},head.appendChild(script),result.promise()},loadStylesheet=function(url){var result=$.Deferred(),link=document.createElement("link");return link.async="async",link.type="text/css",link.rel="stylesheet",link.href=url,link.onload=function(){result.resolve()},link.onerror=function(){result.reject()},head.appendChild(link),result.promise()};$.get("static/conf/plugins.json",function(plugins){ENTERPRISE_PLUGINS=plugins.filter(function(p){return p.enterprise}).map(function(el){return{name:el.name,files:[el.uri],routing:el.routing,stylesheet:el.stylesheet}}),DEFAULT_PLUGINS=plugins.filter(function(p){return!p.enterprise});for(var loadApp=function(){app=angular.module("crate",MODULES),app.config(["SQLQueryProvider","queryResultToObjectsProvider","$ocLazyLoadProvider","$routeProvider","SettingsProvider",function(SQLQueryProvider,queryResultToObjectsProvider,$ocLazyLoadProvider,$routeProvider,SettingsProvider){var stmt="SELECT settings['license']['enterprise'] as enterprise, settings['license']['ident'] as ident FROM sys.cluster",userStmt="SELECT CURRENT_USER";SettingsProvider.$get().enterprise===!0&&loadStylesheet("static/styles/main-enterprise.f374a3fd.css"),SQLQueryProvider.$get().execute(stmt,{},!1,!1,!1).success(function(query){var result=queryResultToObjectsProvider.$get()(query,["enterprise","ident"]);if(SettingsProvider.setEnterprise(result[0].enterprise),SettingsProvider.setIdent(result[0].ident),result[0].enterprise){SQLQueryProvider.$get().execute(userStmt,{},!1,!1,!1).success(function(query){var result=queryResultToObjectsProvider.$get()(query,["user"]);SettingsProvider.setUser(result[0].user)}),loadStylesheet("static/styles/main-enterprise.f374a3fd.css"),$ocLazyLoadProvider.config({modules:ENTERPRISE_PLUGINS,events:!0});for(var i=0;i<ENTERPRISE_PLUGINS.length;i++){$ocLazyLoadProvider.$get().load(ENTERPRISE_PLUGINS[i].name),loadStylesheet(ENTERPRISE_PLUGINS[i].stylesheet);var routing=ENTERPRISE_PLUGINS[i].routing;if(routing)for(var pattern in routing)$routeProvider.when(pattern,routing[pattern])}console.info("Loaded Enterprise Plugins:",ENTERPRISE_PLUGINS.map(function(o){return o.name}))}}).error(function(){SettingsProvider.setEnterprise(!1),console.info("Failed to load Enterprise settings")})}]),app.config(["$routeProvider","$httpProvider",function($routeProvider,$httpProvider){$httpProvider.defaults.useXDomain=!0;var pattern;for(pattern in ROUTING)$routeProvider.when(pattern,ROUTING[pattern]);for(var i=0;i<DEFAULT_PLUGINS.length;i++){var routing=DEFAULT_PLUGINS[i].routing;if(routing)for(pattern in routing)$routeProvider.when(pattern,routing[pattern])}$routeProvider.when("/401",{templateUrl:"static/views/401.html",controller:"UnauthorizedCtrl"}),$routeProvider.otherwise({redirectTo:"/"})}]),app.config(["$translateProvider","$translatePartialLoaderProvider",function($translateProvider,$translatePartialLoaderProvider){$translatePartialLoaderProvider.addPart("."),$translateProvider.useLoader("$translatePartialLoader",{urlTemplate:"{part}/static/i18n/{lang}.json"}).registerAvailableLanguageKeys(["en","de","es"],{"en_*":"en","de_*":"de","es_*":"es","*":"en"}).determinePreferredLanguage().fallbackLanguage("en").useSanitizeValueStrategy(null),$translateProvider.useCookieStorage()}]),app.run(function($rootScope,$translate){$rootScope.$on("$translatePartialLoaderStructureChanged",function(){$translate.refresh()})}),app.run(function($rootScope){$rootScope.$on("showSideNav",function(){$rootScope.showSideNav=!0}),$rootScope.$on("hideSideNav",function(){$rootScope.showSideNav=!1})}),app.run(function($rootScope){$rootScope.$on("showSideNav",function(){$rootScope.showSideNav=!0,$rootScope.showTableList=!0,$rootScope.showNodeList=!0}),$rootScope.$on("hideSideNav",function(){$rootScope.showSideNav=!1,$rootScope.showTableList=!1,$rootScope.showNodeList=!1})}),angular.element(document).ready(function(){angular.bootstrap(document,["crate"])})},promises=[],i=0;i<DEFAULT_PLUGINS.length;i++)promises.push(loadScript(DEFAULT_PLUGINS[i].uri)),DEFAULT_PLUGINS[i].stylesheet&&promises.push(loadStylesheet(DEFAULT_PLUGINS[i].stylesheet));$.when.apply($,promises).then(function(){console.info("Loaded Modules:",MODULES),console.info("Default Plugins:",DEFAULT_PLUGINS.map(function(el){return el.name})),MODULES=MODULES.concat(DEFAULT_PLUGINS.map(function(el){return el.name})),loadApp()},function(){console.info("Loaded Modules:",MODULES),console.warn("Plugins could not be loaded. Please check your config file: plugins.json"),loadApp()})}),angular.module("utils",[]).service("parseIsoDatetime",function(){return function(dtstr){var dt=dtstr.split(/[: T+-]/).map(parseFloat);return new Date(dt[0],dt[1]-1,dt[2],dt[3]||0,dt[4]||0,dt[5]||0,0)}}),angular.module("sql",[]).factory("queryResultToObjects",function(){var toObject=function(headers,row){var obj={};if(headers.length==row.length)for(var i=0;i<headers.length;i++)obj[headers[i]]=row[i];return obj};return function(sqlQuery,headers){return sqlQuery.rows.map(function(obj){return toObject(headers,obj)})}}).factory("baseURI",function(){var baseURI={};return baseURI.getWindowLocation=function(){return window.location},baseURI.getURI=function(path){var basePath,loc=baseURI.getWindowLocation(),uriParam=loc.search.match(/([\?|&])base_uri=([^&]+)/);return basePath=uriParam?uriParam[2]:loc.protocol+"//"+loc.host+loc.pathname,basePath.replace(/\/+$/,"")+path},baseURI}).factory("SQLQuery",function($http,$q,$log,baseURI,$location){function SQLQuery(stmt,response,error){this.stmt=stmt,this.rows=[],this.cols=[],this.col_types=[],this.rowCount=0,this.duration=0,this.error=error,this.failed=!1,!this.error&&response?(this.rows=response.rows,this.cols=response.cols,this.col_types=void 0===response.col_types?[]:response.col_types,this.rowCount=response.rowcount,this.duration=response.duration):this.failed=!0}return SQLQuery.prototype.status=function(){var status_string="",stmt_parts=this.stmt.split(" "),cmd=stmt_parts[0].toUpperCase();return cmd in{CREATE:"",DROP:""}&&(cmd=cmd+" "+stmt_parts[1].toUpperCase()),this.failed===!1?(status_string=cmd+" OK ("+(this.duration/1e3).toFixed(3)+" sec)",$log.info("Query status: "+status_string)):(status_string=cmd+" ERROR ("+(this.duration/1e3).toFixed(3)+" sec)",$log.warn("Query status: "+status_string)),status_string},SQLQuery.execute=function(stmt,args,errorTrace,getTypes,isConsole){var data={stmt:stmt};$.isEmptyObject(args)||(data.args=args);var canceler=$q.defer(),deferred=$q.defer(),promise=deferred.promise;promise.success=function(fn){return promise.then(function(sqlQuery){fn(sqlQuery)}),promise},promise.error=function(fn){return promise.then(null,function(sqlQuery){fn(sqlQuery)}),promise},promise.cancel=function(){canceler.reject()};var request={url:baseURI.getURI("/_sql"+(getTypes?"?types":"")),method:"POST",data:data,config:{timeout:canceler.promise}};return errorTrace===!0&&(request.params={error_trace:errorTrace}),$http(request).success(function(data){deferred.resolve(new SQLQuery(stmt,data,null))}).error(function(data,status){var error=null;status>=400&&data.error?(error=new Error(data.error.message),error.error_trace=data.error_trace,error.status=data.error.code,4011!==data.error.code||isConsole||$location.path("/401")):status>=400?(error=new Error(data),error.status=status):0===status&&(error=new Error("Connection refused"),error.status=status),deferred.reject(new SQLQuery(stmt,data,error))}),promise},SQLQuery}),angular.module("health",[]).factory("Health",function(){var map={},Health=function Health(level){this.set=function(level){this.level=isNaN(level)?Health.UNKNOWN:level,this.name=Health.NAMES[this.level]||"--"},this.toString=function(){return this.name},this.set(level)};return Health.NAMES=["good","warning","critical"],Health.NAMES.map(function(obj,idx){map[obj]=idx}),Health.UNKNOWN=-1,Health.GOOD=0,Health.WARNING=1,Health.CRITICAL=2,Health.fromString=function(name){return new Health(map[name])},Health}),angular.module("stats",["sql","health","tableinfo","nodeinfo"]).factory("ClusterState",function($http,$interval,$timeout,$log,$q,baseURI,SQLQuery,queryResultToObjects,TableList,Health,ShardInfo,NodeInfo){var healthInterval,statusInterval,reachabilityInterval,shardsInterval,checkInterval,refreshShardInfo,refreshState,refreshHealth,checkReachability,setReachability,data={online:!0,tables:[],shards:[],partitions:[],cluster:[],name:"--",status:"--",load:["-.-","-.-","-.-"],loadHistory:[[],[],[]],version:null},diskIoHistory={},refreshInterval=5e3,historyLength=60;setReachability=function(online){data.online&&!online?(data.online=!1,$log.warn("Cluster is offline."),$interval.cancel(healthInterval),$interval.cancel(statusInterval),$interval.cancel(shardsInterval),$interval.cancel(checkInterval),data.status="--",data.tables=[],data.cluster=[],data.name="--",data.load=["-.-","-.-","-.-"],data.loadHistory=[[],[],[]],data.version=null):!data.online&&online&&(data.online=!0,$log.info("Cluster is online."),healthInterval=$interval(refreshHealth,refreshInterval),refreshHealth(),statusInterval=$interval(refreshState,refreshInterval),refreshState(),shardsInterval=$interval(refreshShardInfo,refreshInterval),refreshShardInfo())},checkReachability=function(){$http.get(baseURI.getURI("/"),{headers:{Accept:"application/json"}}).success(function(response){if("object"==typeof response){var version=response.version;data.version={number:version.number,hash:version.build_hash,snapshot:version.build_snapshot},setReachability(!0)}else data.version=null,setReachability(!1)}).error(function(){setReachability(!1)})};var addToLoadHistory=function(load){var lh=data.loadHistory;if(load.length==lh.length)for(var i=0;i<load.length;i++)lh[i].push(load[i]),lh[i]=lh[i].splice(-historyLength,historyLength)},onErrorResponse=function(query){if(query&&query.error){var status=query.error.status;setReachability(!(0===status||404===status))}},prepareLoadInfo=function(nodeInfo){for(var numNodes=nodeInfo.length,load=[0,0,0],i=0;i<numNodes;i++){var nodeLoad=nodeInfo[i].load;nodeLoad&&(load[0]+=nodeLoad[1]/numNodes,load[1]+=nodeLoad[5]/numNodes,load[2]+=nodeLoad[15]/numNodes)}return addToLoadHistory(load),load},prepareIoStats=function(nodeInfo){for(var numNodes=nodeInfo.length,i=0;i<numNodes;i++){var node=nodeInfo[i],currentValue={timestamp:node.timestamp,data:node.fs.total};if(diskIoHistory[node.id]){var lastValue=diskIoHistory[node.id],timeDelta=(currentValue.timestamp-lastValue.timestamp)/1e3,readsDelta=currentValue.data.reads-lastValue.data.reads,writesDelta=currentValue.data.writes-lastValue.data.writes,readBytesDelta=currentValue.data.bytes_read-lastValue.data.bytes_read,writtenBytesDelta=currentValue.data.bytes_written-lastValue.data.bytes_written;node.iostats={rps:currentValue.data.reads>0?readsDelta/timeDelta:-1,wps:currentValue.data.writes>0?writesDelta/timeDelta:-1,rbps:currentValue.data.bytes_read>0?readBytesDelta/timeDelta:-1,wbps:currentValue.data.bytes_written>0?writtenBytesDelta/timeDelta:-1}}else node.iostats={rps:-1,wps:-1,rbps:-1,wbps:-1};diskIoHistory[node.id]=currentValue}return nodeInfo};return refreshHealth=function(){TableList.execute().then(null,null,function(res){if(res.success||!data.online){var h=res.data.tables.reduce(function(memo,obj){var health=Health.fromString(obj.health);return Math.max(health.level,memo)},0);data.status=new Health(h).name,data.tables=res.data.tables}else data.status="--",data.tables=[]})},refreshState=function(){NodeInfo.executeNodeQuery().then(function(response){data.online&&(data.load=prepareLoadInfo(response),data.cluster=prepareIoStats(response),NodeInfo.executeClusterQuery().then(function(response){if(data.online){data.name=response[0].name,data.master_node=response[0].master_node;var result={name:data.name,master_node:data.master_node,nodes:data.cluster.length};NodeInfo.deferred.resolve(result)}},onErrorResponse))},onErrorResponse)},refreshShardInfo=function(){data.online&&ShardInfo.executeTableStmt().then(function(tables){ShardInfo.executeShardStmt().then(function(shards){ShardInfo.executePartStmt().then(function(partitions){ShardInfo.executeRecoveryStmt().then(function(recovery){data.shards=shards,data.tables=tables,data.partitions=partitions,data.recovery=recovery;var result={tables:data.tables,shards:data.shards,partitions:data.partitions,recovery:data.recovery};ShardInfo.deferred.resolve(result)}).catch(function(){var result={tables:data.tables,shards:data.shards,partitions:data.partitions};ShardInfo.deferred.reject(result)})}).catch(function(){var result={tables:data.tables,shards:data.shards};ShardInfo.deferred.reject(result)})}).catch(function(){var result={tables:data.tables};ShardInfo.deferred.reject(result)})}).catch(function(){ShardInfo.deferred.reject({})})},checkReachability(),reachabilityInterval=$interval(checkReachability,refreshInterval),refreshHealth(),healthInterval=$interval(refreshHealth,refreshInterval),refreshShardInfo(),shardsInterval=$interval(refreshShardInfo,refreshInterval),refreshState(),$timeout(refreshState,500),statusInterval=$interval(refreshState,refreshInterval),{data:data,HISTORY_LENGTH:historyLength}}),angular.module("tableinfo",["sql"]).factory("TableInfo",function(){var ACTIVE_SHARDS=["STARTED","RELOCATING"],isActiveShard=function(shard){return ACTIVE_SHARDS.indexOf(shard.routing_state)>-1};return function(arg1,arg2,arg3,arg4){var shards=arg1?angular.copy(arg1):[],partitionedBy=arg3?angular.copy(arg3):[],partitioned=partitionedBy.length>0,numShardsConfigured=arg2||0,recovery=arg4||[],primaryShards=function(){return shards.filter(function(shard){return shard.primary})}(),numPrimaryShards=function(){return primaryShards.reduce(function(memo,shard){return memo+shard.count},0)}(),startedShards=function(){return shards.filter(function(shard){return isActiveShard(shard)})}(),numStartedShards=function(){return startedShards.reduce(function(memo,shard){return memo+shard.count},0)}(),numActivePrimaryShards=function(){return shards.filter(function(shard){return isActiveShard(shard)&&shard.primary===!0}).reduce(function(memo,shard){return memo+shard.count},0)}(),shardSize=function(){return primaryShards.reduce(function(memo,shard){return memo+shard.size},0)}(),numRecords=function(){return primaryShards.reduce(function(memo,shard){return memo+shard.sum_docs},0)}(),numMissingPrimaryShards=function(){return partitioned&&0===numStartedShards?0:Math.max(0,numShardsConfigured-numActivePrimaryShards)}(),numUnassignedShards=function(){return shards.filter(function(shard){return"UNASSIGNED"==shard.routing_state}).reduce(function(memo,shard){return memo+shard.count},0)}(),numReplicatingShards=function(){return shards.filter(function(shard){return"INITIALIZING"==shard.routing_state&&null===shard.relocating_node}).reduce(function(memo,shard){return memo+shard.count},0)}(),numUnderreplicatedShards=function(){return Math.max(0,numUnassignedShards+numReplicatingShards-numMissingPrimaryShards)}(),avgDocsPerPrimaryShard=function(){return primaryShards.reduce(function(memo,shard,idx,arr){return memo+shard.avg_docs/arr.length},0)}(),numUnderreplicatedRecords=function(){return Math.ceil(avgDocsPerPrimaryShard*numUnassignedShards)}(),numRecordsWithReplicas=function(){var numShards=shards.reduce(function(memo,shard){return memo+shard.count},0);return Math.ceil(avgDocsPerPrimaryShard*numShards)}(),numUnavailableRecords=function(){var avgDocsPerStartedShard=startedShards.reduce(function(memo,shard,idx,arr){return memo+shard.avg_docs/arr.length},0);return Math.ceil(avgDocsPerStartedShard*numMissingPrimaryShards)}(),health=function(){if(partitioned){if(0===numStartedShards&&0===numMissingPrimaryShards&&0===numUnassignedShards&&0===numUnderreplicatedShards)return"good";if(0===numPrimaryShards||numMissingPrimaryShards>0)return"critical";if(numUnassignedShards>0||numUnderreplicatedShards>0)return"warning"}else{if(0===numPrimaryShards||numMissingPrimaryShards>0)return"critical";if(numUnassignedShards>0||numUnderreplicatedShards>0)return"warning"}return"good"}(),recovery_percent=0===shards.length||0===recovery.length?100:function(){var done=recovery.filter(function(data){return data.recovery_stage&&"DONE"===data.recovery_stage}).reduce(function(memo,data){return[memo[0]+100*data.count,memo[1]+data.count]},[0,0]),progress=recovery.filter(function(data){return data.recovery_stage&&"DONE"!==data.recovery_stage}).reduce(function(memo,data){return[memo[0]+data.recovery_percent*data.count,memo[1]+data.count]},[0,0]),unassigned=recovery.filter(function(data){return null===data.recovery_stage}).reduce(function(memo,data){return[0,memo[1]+data.count]},[0,0]),percent=(done[0]+progress[0]+unassigned[0])/(done[1]+progress[1]+unassigned[1]);return percent}();this.asObject=function(){return{shards_configured:numShardsConfigured,health:health,shards_started:numStartedShards,shards_missing:numMissingPrimaryShards,shards_underreplicated:numUnderreplicatedShards,records_total:numRecords,records_total_with_replicas:numRecordsWithReplicas,records_unavailable:numUnavailableRecords,records_underreplicated:numUnderreplicatedRecords,size:shardSize,partitioned:partitioned,partitioned_by:partitionedBy,recovery_percent:recovery_percent}}}}).factory("TableList",function($timeout,$q,TableInfo,SQLQuery,roundWithUnitFilter,bytesFilter,ShardInfo){var fetch,deferred=$q.defer(),data={tables:[]},timeout=null,refreshInterval=5e3,healthPriorityMap={good:2,warning:1,critical:0,"--":0},colorMapLabel={good:"label-success",warning:"label-warning",critical:"label-danger","--":""},colorMapPanel={good:"cr-panel--success",warning:"cr-panel--warning",critical:"cr-panel--danger","--":"cr--panel-default"},sortByHealth=function(a,b){return healthPriorityMap[a.health]<healthPriorityMap[b.health]?-1:healthPriorityMap[a.health]>healthPriorityMap[b.health]?1:a.name<b.name?-1:a.name>b.name?1:0},tableFilter=function(table){return function(item){return item.table_name===table.name&&item.schema_name==table.table_schema}},update=function(success,tables,shards,partitions,recovery){var _tables=tables||[],_shards=shards||[],_partitions=partitions||[],_recovery=recovery||[];if(success&&_tables.length){for(var i=0;i<_tables.length;i++){var table=_tables[i],filterBySchemaNameTableName=tableFilter(table),shardsForTable=_shards.filter(filterBySchemaNameTableName),partitionsForTable=_partitions.filter(filterBySchemaNameTableName),recoveryForTable=_recovery.filter(filterBySchemaNameTableName);table.partitioned_by&&1===partitionsForTable.length&&(table.shards_configured=partitionsForTable[0].num_shards);var tableInfo=new TableInfo(shardsForTable,table.shards_configured,table.partitioned_by,recoveryForTable),info=tableInfo.asObject();$.extend(table,info),table.health_label_class=colorMapLabel[table.health],table.health_panel_class=colorMapPanel[table.health],table.type_display_name="blob"==table.table_schema?"TABLE.BLOBS":"TABLE.RECORDS";var summary=table.shards_configured+" Shards";summary+=" / "+table.replicas_configured+" Replicas",table.records_unavailable?summary=roundWithUnitFilter(table.records_unavailable,1)+" Unavailable Records / "+summary:table.shards_underreplicated&&(summary=table.shards_underreplicated+" Underreplicated Shards / "+summary),table.records_underreplicated&&(summary=table.records_underreplicated+" Underreplicated Records / "+summary),table.summary=summary}data.tables=_tables.sort(sortByHealth)}else data.tables=[];deferred.notify({success:success,data:data}),timeout=$timeout(fetch,refreshInterval)};return fetch=function(){$timeout.cancel(timeout),ShardInfo.deferred.promise.then(function(result){update(!0,result.tables,result.shards,result.partitions,result.recovery)}).catch(function(result){jQuery.isEmptyObject(result)||(result.tables&&result.shards&&result.recovery?update(!0,result.tables,result.shards,null,result.recovery):result.tables?update(!0,result.tables):update(!1))}).finally(function(){ShardInfo.deferred.promise=$q.defer().promise,fetch()})},fetch(),{data:data,fetch:fetch,execute:function(){return deferred.promise}}}),angular.module("shardinfo",["sql"]).factory("ShardInfo",function(SQLQuery,queryResultToObjects,$q){var shardInfo={deferred:$q.defer()},tableStmt="SELECT table_name, table_schema, format('%s.%s', table_schema, table_name) AS fqn, number_of_shards, number_of_replicas, partitioned_by FROM information_schema.tables WHERE table_schema NOT IN ('information_schema', 'sys', 'pg_catalog')",shardStmt="SELECT table_name, schema_name, format('%s.%s', schema_name, table_name) AS fqn, _node['id'] AS node_id, state, routing_state, relocating_node, count(*), \"primary\", sum(num_docs), avg(num_docs), sum(size) FROM sys.shards GROUP BY table_name, schema_name, fqn, node_id, state, routing_state, relocating_node, \"primary\"",partStmt="SELECT table_name, schema_name, format('%s.%s', schema_name, table_name) AS fqn, SUM(number_of_shards) AS num_shards FROM information_schema.table_partitions GROUP BY table_name, schema_name, fqn",recoveryStmt="SELECT table_name, schema_name, recovery['stage'] AS recovery_stage, AVG(recovery['size']['percent']), COUNT(*) AS count FROM sys.shards GROUP BY table_name, schema_name, recovery_stage";return shardInfo.executeTableStmt=function(){var deferred=$q.defer(),promise=deferred.promise;return SQLQuery.execute(tableStmt,{},!1,!1,!1).success(function(tableQuery){var result=queryResultToObjects(tableQuery,["name","table_schema","fqn","shards_configured","replicas_configured","partitioned_by"]);deferred.resolve(result)}).error(function(){deferred.reject()}),promise},shardInfo.executeShardStmt=function(){var deferred=$q.defer(),promise=deferred.promise;return SQLQuery.execute(shardStmt,{},!1,!1,!1).success(function(shardQuery){var result=queryResultToObjects(shardQuery,["table_name","schema_name","fqn","node_id","state","routing_state","relocating_node","count","primary","sum_docs","avg_docs","size"]);deferred.resolve(result)}).error(function(){deferred.reject()}),promise},shardInfo.executePartStmt=function(){var deferred=$q.defer(),promise=deferred.promise;return SQLQuery.execute(partStmt,{},!1,!1,!1).success(function(partQuery){var result=queryResultToObjects(partQuery,["table_name","schema_name","fqn","num_shards"]);deferred.resolve(result)}).error(function(){deferred.reject()}),promise},shardInfo.executeRecoveryStmt=function(){var deferred=$q.defer(),promise=deferred.promise;return SQLQuery.execute(recoveryStmt,{},!1,!1,!1).success(function(recoveryQuery){var result=queryResultToObjects(recoveryQuery,["table_name","schema_name","recovery_stage","recovery_percent","count"]);deferred.resolve(result)}).error(function(){deferred.reject()}),promise},shardInfo}),angular.module("nodeinfo",["sql"]).factory("NodeHealth",function(){var state=function(val){return val>98?2:val>90?1:0};return function(node){this.value=state(Math.max(node.fs.used_percent,node.heap.used_percent)),this.status=["good","warning","critical"][this.value]}}).factory("NodeInfo",function(SQLQuery,queryResultToObjects,$q){var nodeInfo={deferred:$q.defer()},nodeQuery="SELECT id, name, hostname, rest_url, port, heap, fs, os['cpu'], load, version, os['probe_timestamp'], process['cpu'], os_info['available_processors'] FROM sys.nodes ORDER BY id",nodeCols=["id","name","hostname","rest_url","port","heap","fs","cpu","load","version","timestamp","proc_cpu","num_cores"];nodeInfo.executeNodeQuery=function(){var d=$q.defer();return SQLQuery.execute(nodeQuery,{},!1,!1,!1).success(function(sqlQuery){var response=queryResultToObjects(sqlQuery,nodeCols);d.resolve(response)}).error(function(){d.reject()}),d.promise};var clusterQuery="select name, master_node from sys.cluster",clusterCols=["name","master_node"];return nodeInfo.executeClusterQuery=function(){var d=$q.defer();return SQLQuery.execute(clusterQuery,{},!1,!1,!1).success(function(sqlQuery){d.resolve(queryResultToObjects(sqlQuery,clusterCols))}).error(function(){d.reject()}),d.promise},nodeInfo}).provider("NodeListInfo",function(){var sortInfo={sort:{col:["health_value","name"],desc:!1},sortBy:function(col){0===this.sort.col.indexOf(col)?this.sort.desc=!this.sort.desc:(this.sort.col=this.sort.col.reverse(),this.sort.desc=!1)},sortClass:function(col){return 0===this.sort.col.indexOf(col)?this.sort.desc?"fa fa-caret-down":"fa fa-caret-up":""}};this.$get=function(){return sortInfo}}).factory("prepareNodeList",function(NodeHealth){var LABEL_COLOR_MAP={good:"label-success",warning:"label-warning",critical:"label-danger","--":""};return function(cluster,master_node){for(var nodeList=[],i=0;i<cluster.length;i++){var node=angular.copy(cluster[i]);node.health=new NodeHealth(node),node.health_value=node.health.value,node.health_label_class=LABEL_COLOR_MAP[node.health.status],node.health_panel_class=LABEL_COLOR_MAP[node.health.status],node.heap.used_percent=100*node.heap.used/node.heap.max,node.heap.free_percent=100-node.heap.used_percent,node.master_node=node.id===master_node,nodeList.push(node)}return nodeList}}).factory("compareByHealth",function(){return function(a,b){return a.health.value<b.health.value?-1:a.health.value>b.health.value?1:a.name<b.name?-1:a.name>b.name?1:0}}),angular.module("checks",["sql"]).factory("ClusterCheck",function(SQLQuery,queryResultToObjects,$q){var self={deferred:$q.defer()},stmt="SELECT id, severity, description, passed FROM sys.checks WHERE passed = FALSE ORDER BY severity DESC, id",cols=["id","severity","description","passed"];return self.execute=function(){var deferred=$q.defer(),promise=deferred.promise;return SQLQuery.execute(stmt,{},!1,!1,!1).success(function(query){var result=queryResultToObjects(query,cols);deferred.resolve(result)}).error(function(){deferred.reject()}),promise},self}).factory("NodeCheck",function(SQLQuery,queryResultToObjects,$q){var self={deferred:$q.defer()},stmt="SELECT c.id, c.severity, c.description, c.passed, c.node_id, n.name, c.acknowledged FROM sys.node_checks AS c, sys.nodes AS n WHERE c.node_id = n.id AND c.passed = FALSE AND acknowledged = FALSE ORDER BY c.severity DESC, n.name",cols=["id","severity","description","passed","node_id","node_name","acknowledged"];return self.execute=function(){var deferred=$q.defer(),promise=deferred.promise;return SQLQuery.execute(stmt,{},!1,!1,!1).success(function(query){var result=queryResultToObjects(query,cols),checks={};result.map(function(check){var id=check.id;id in checks||(check.nodes=[],checks[id]=check),checks[id].nodes.push({name:check.node_name,id:check.node_id})});var array=Object.keys(checks).map(function(id){return checks[id]});deferred.resolve(array)}).error(function(){deferred.reject()}),promise},self}).factory("ChecksService",function($timeout,$q,NodeCheck,ClusterCheck){var data={checks:{},success:!1},retryCount=0;return data.fetch=function(force){$q.all([ClusterCheck.execute(),NodeCheck.execute()]).then(function(responses){data.checks.cluster_checks=responses[0],data.checks.node_checks=responses[1],data.success=!0,retryCount=0,force!==!0&&$timeout(data.fetch,6e4)}).catch(function(){data.success=!1,retryCount++,force!==!0&&$timeout(data.fetch,500*retryCount)})},$timeout(data.fetch,2e3),data.refresh=function(){data.fetch(!0)},data}),angular.module("udc",[]).factory("UdcSettings",function(SQLQuery,queryResultToObjects,$q){var deferred=$q.defer(),promise=deferred.promise;promise.success=function(result){return promise.then(result,null,null),promise},promise.error=function(error){return promise.then(null,error,null),promise};var stmt="SELECT settings['udc']['enabled'] as enabled, id AS cluster_id FROM sys.cluster";return SQLQuery.execute(stmt,{},!1,!1,!1).success(function(query){var result=queryResultToObjects(query,["enabled","cluster_id"]);deferred.resolve(result[0])}).error(function(){deferred.reject("Could not load udc setting")}),{SegmentIoToken:"sfTz0KpAhR0KmOH4GnoqbpLID71eaB3w",availability:promise}}).factory("Uid",function(){var Uid=function(uid){this.uid=uid};return Uid.create=function(uid){return new Uid(uid)},Uid.prototype.isValid=function(){return!!this.uid&&null!==this.uid.match(/^[a-f0-9]{32}$/)},Uid.prototype.toString=function(){return this.uid},Uid.NAME="uid",Uid}).factory("UidLoader",function($q,Uid){var cachedUid=null,loadIframe=function(uri){var ifr=document.createElement("iframe");return ifr.id="ifr"+(new Date).getTime(),ifr.style.width="0px",ifr.style.height="0px",ifr.src=uri,document.getElementsByTagName("body")[0].appendChild(ifr),ifr},DOMAIN="cdn.crate.io",PATH="/libs/crate/uid.html";return{load:function(){var deferred=$q.defer(),promise=deferred.promise;if(promise.success=function(fn){return promise.then(fn,null,null),promise},promise.error=function(fn){return promise.then(null,fn,null),promise},promise.notify=function(fn){return promise.then(null,null,fn),promise},null===cachedUid){window.addEventListener("message",function(event){if(event.origin.match(DOMAIN)){deferred.notify(event);var uid=Uid.create(event.data[Uid.NAME]);uid.isValid()?(cachedUid=uid,deferred.resolve(uid)):deferred.reject(new Error("Cookie failed to load"))}},!1);var protocol="https:"===window.location.protocol?"https:":"http:";loadIframe(protocol+"//"+DOMAIN+PATH)}else deferred.resolve(cachedUid);return promise}}}),angular.module("translation",[]).factory("Translation",function(){var TranslationService=this;return TranslationService.interpolate=function(sentence,terms){for(var term in terms){var regex=new RegExp("\\{"+term+"\\}","gi");sentence=sentence.replace(regex,terms[term])}return sentence},TranslationService}),angular.module("datatypechecks",[]).factory("ColumnTypeCheck",function(){var ColumnTypeCheck={},formattedDataTypes=[11,13,14,12];return ColumnTypeCheck.isGeopoint=function(dataType){return 13==dataType},ColumnTypeCheck.isGeoarea=function(dataType){return 14==dataType},ColumnTypeCheck.isTimestamp=function(dataType){return 11==dataType},ColumnTypeCheck.requiresJSONFormatting=function(dataType){return 12==dataType},ColumnTypeCheck.requiresArrayFormatting=function(dataType){return Array.isArray(dataType)},ColumnTypeCheck.requiresNoFormatting=function(dataType){return!(formattedDataTypes.indexOf(dataType)!=-1||Array.isArray(dataType))},ColumnTypeCheck.isSafe=function(number){return!Number.isInteger(number)||Number.isSafeInteger(number)},ColumnTypeCheck}).factory("ObjectTypeCheck",function($filter){var ObjectTypeCheck={};return ObjectTypeCheck.isArray=function(object){return Array.isArray(object)},ObjectTypeCheck.isObject=function(object){return!this.isArray(object)&&"object"==typeof object},ObjectTypeCheck.isValue=function(object){return!this.isArray(object)&&!this.isObject(object)},ObjectTypeCheck.getType=function(object){return typeof object},ObjectTypeCheck.getArrayBaseType=function(array,typesArray){return 1==typesArray[1]?this.getType(array[0]):$filter("columnTypeClass")(typesArray[1])},ObjectTypeCheck});var commons=angular.module("common",["stats","udc"]).provider("Settings",function(){var enterprise,ident="",user="";return enterprise=!!localStorage.getItem("crate_setting_enterprise")&&localStorage.getItem("crate_setting_enterprise"),
{setEnterprise:function(value){enterprise=value;try{localStorage.setItem("crate_setting_enterprise",value)}catch(error){console.log("localStorage cannot be set in Safari private mode",error)}},setIdent:function(value){ident=value},setUser:function(value){user=value},$get:function(){return{enterprise:enterprise,ident:ident,user:user}}}}).controller("UnauthorizedCtrl",[function(){}]).controller("StatusBarController",function($scope,$rootScope,$log,$location,$translate,$sce,ClusterState,ChecksService,UidLoader,UdcSettings,Settings){var HEALTH=["good","warning","critical","--"],LABELS=["cr-bubble--success","cr-bubble--warning","cr-bubble--danger","cr-bubble--danger"],colorMap=HEALTH.reduce(function(memo,o,idx){return memo[o]=LABELS[idx],memo},{}),DOCS_BASE_URL="https://crate.io/docs",getDocsUrl=function(version){return $sce.trustAsResourceUrl(DOCS_BASE_URL+(version?"/en/"+version.number:"/stable")+"/")};$scope.cluster_color_label="",$scope.config_label="";var showSideNav=!1;$scope.enterprise=Settings.enterprise,$scope.licenseIdent=Settings.ident,$scope.userName=Settings.user,$scope.toggleSideNav=function(){showSideNav=!showSideNav,showSideNav?$rootScope.$broadcast("showSideNav"):$rootScope.$broadcast("hideSideNav")},$scope.showSettings=!1,$scope.toggleSettings=function(){$scope.showSettings=!$scope.showSettings},$scope.$watch(function(){return ChecksService},function(data){if(data.success===!0){var checks=[];checks.push.apply(checks,data.checks.cluster_checks),checks.push.apply(checks,data.checks.node_checks);var severity=checks.reduce(function(memo,obj){return Math.max(memo,obj.severity)},1);$translate(["STATUSBAR.CHECK","STATUSBAR.CHECKS","STATUSBAR.FAILED"]).then(function(i18n){$scope.checks_message=$sce.trustAsHtml([checks.length,1==checks.length?i18n["STATUSBAR.CHECK"]:i18n["STATUSBAR.CHECKS"],i18n["STATUSBAR.FAILED"]].join("Â ")),$scope.config_label=LABELS[Math.min(severity-1,LABELS.length-1)]})}else $translate(["STATUSBAR.CLUSTER_OFFLINE"]).then(function(i18n){$scope.checks_message=$sce.trustAsHtml(i18n["STATUSBAR.CLUSTER_OFFLINE"])}),$scope.config_label=""},!0),$scope.$watch(function(){return ClusterState.data},function(data){var hashes=[],versions=data.cluster.filter(function(obj){var contains=!1;if(obj.version){var hash=obj.version.build_hash;contains=hashes.indexOf(hash)==-1,hashes.push(hash)}return contains}).map(function(obj){return obj.version.number});$scope.versions=versions,$scope.version_warning=versions.length>1,$scope.cluster_state=data.status,$scope.cluster_name=data.name,$scope.num_nodes=data.cluster.length,$scope.load1="-.-"==data.load[0]?data.load[0]:data.load[0].toFixed(2),$scope.load1=$scope.load1<0?"N/A":$scope.load1,$scope.load5="-.-"==data.load[1]?data.load[1]:data.load[1].toFixed(2),$scope.load5=$scope.load5<0?"N/A":$scope.load5,$scope.load15="-.-"==data.load[2]?data.load[2]:data.load[2].toFixed(2),$scope.load15=$scope.load15<0?"N/A":$scope.load15,$scope.version=data.version,$scope.docs_url=getDocsUrl(data.version),$scope.cluster_color_label=data.online?colorMap[data.status]:""},!0),$("[rel=tooltip]").tooltip({placement:"bottom"});var verified=null;$scope.user={uid:null},analytics.load(UdcSettings.SegmentIoToken),analytics.ready(function(){var user=analytics.user();verified={id:user.id(),traits:user.traits()}});var identify=function(userdata){null!==userdata.user.uid&&(analytics.setAnonymousId(userdata.user.uid),analytics.identify(userdata.user.uid),analytics.page(),analytics.track("visited_admin",{version:$scope.version.number,cluster_id:userdata.cluster_id}))};UdcSettings.availability.success(function(data){data.enabled===!0&&UidLoader.load().success(function(uid){$scope.user.uid=uid.toString(),identify({user:$scope.user,cluster_id:data.cluster_id})}).error(function(error){console.warn(error)})})}).controller("NavigationController",function($scope,$rootScope,$location,NavigationService){$scope.navBarElements=NavigationService.navBarElements,$scope.showSideNav=!1,$rootScope.$on("showSideNav",function(){$scope.showSideNav=!0}),$rootScope.$on("hideSideNav",function(){$scope.showSideNav=!1}),$scope.goToPath=function(path){$location.path(path)},$scope.isActive=function(viewLocation){return"/"==viewLocation?viewLocation===$location.path():$location.path().substr(0,viewLocation.length)==viewLocation}}).service("NavigationService",function(){var navBarElements=[],addNavBarElement=function(iconClass,text,urlPattern,index){"/"!=urlPattern.charAt(0)&&(urlPattern="/"+urlPattern);var pluginElement={text:text,iconSrc:iconClass,urlPattern:urlPattern};"undefined"==typeof index?navBarElements.push(pluginElement):index<0||index>=navBarElements.length?navBarElements.push(pluginElement):navBarElements.splice(index,0,pluginElement)},updateNavBarElement=function(urlPattern,text){"/"!=urlPattern.charAt(0)&&(urlPattern="/"+urlPattern);var queryElements=navBarElements.filter(function(item){return item.urlPattern==urlPattern});0!==queryElements.length&&(queryElements[0].text=text)};return{addNavBarElement:addNavBarElement,updateNavBarElement:updateNavBarElement,navBarElements:navBarElements}}).directive("focus",function($timeout){return{scope:{trigger:"@focus"},link:function(scope,element){scope.$watch("trigger",function(value){value&&$timeout(function(){element[0].focus()})})}}}).directive("fixBottom",function(){return function(scope,element){var elem=$(element),nav=$(".side-nav .navbar-nav"),win=$(window),calculate=function(){scope.fixBottom=nav.offset().top+nav.height()+elem.height()<win.height()};win.on("resize",calculate),calculate()}}).controller("LanguageSwitchController",function($scope,$translate){$scope.showDropDown=!1,$scope.toggleDropDown=function(){$scope.showDropDown=!$scope.showDropDown},$scope.selectedLanguage="auto",$scope.changeLanguage=function(langKey){langKey="auto"===langKey?$translate.preferredLanguage():langKey,$translate.use(langKey),$scope.selectedLanguage=langKey,$scope.toggleDropDown()}}).directive("crTooltip",function(){return{restrict:"A",scope:{crTooltipPosition:"="},link:function(scope,element,attrs){$(element[0]).tooltip({placement:attrs.crTooltipPosition})}}});commons.run(function(NavigationService,$translate,$filter,$rootScope){NavigationService.addNavBarElement("static/assets/icon-overview.e4111b28.svg",$filter("translate","NAVIGATION.OVERVIEW"),"/"),NavigationService.addNavBarElement("static/assets/icon-console.33b8f8be.svg",$filter("translate","NAVIGATION.CONSOLE"),"/console"),NavigationService.addNavBarElement("static/assets/icon-table.7602d1ff.svg",$filter("translate","NAVIGATION.TABLE"),"/tables"),NavigationService.addNavBarElement("static/assets/icon-cluster.dd7a24b9.svg",$filter("translate","NAVIGATION.CLUSTER"),"/nodes"),$rootScope.$on("$translateChangeSuccess",function(){$translate(["NAVIGATION.OVERVIEW","NAVIGATION.CONSOLE","NAVIGATION.TABLE","NAVIGATION.CLUSTER"]).then(function(i18n){NavigationService.updateNavBarElement("/",i18n["NAVIGATION.OVERVIEW"]),NavigationService.updateNavBarElement("/console",i18n["NAVIGATION.CONSOLE"]),NavigationService.updateNavBarElement("/tables",i18n["NAVIGATION.TABLE"]),NavigationService.updateNavBarElement("/nodes",i18n["NAVIGATION.CLUSTER"])})})}),angular.module("feed",["stats","udc","utils"]).factory("QueryStringAppender",function(){return{append:function(url,k,v){var qs=k+"="+v;return url.indexOf("?")>-1?url+"&"+qs:url+"?"+qs}}}).factory("FeedService",function($http,QueryStringAppender){return{parse:function(url){var fullUrl=QueryStringAppender.append(url,"callback","JSON_CALLBACK");return $http.jsonp(fullUrl,{cache:!1})}}}).factory("NotificationService",function(){var readItems=null,key="crate.readNotifications";return{readItems:function(){if(null===readItems){var v=localStorage.getItem(key);readItems=v?JSON.parse(v):[]}return readItems},markAsRead:function(id){var items=this.readItems();items.push(id),readItems=items,localStorage.setItem(key,JSON.stringify(items))}}}).controller("NotificationsController",function($scope,$sce,$http,$filter,$window,FeedService,QueryStringAppender,NotificationService,ClusterState,UdcSettings,UidLoader){var CRATE_IO="https://crate.io",doNotTrackUrl=function(url){return QueryStringAppender.append(url,"udc.enabled","false")};$scope.blog_url=CRATE_IO+"/blog",$scope.demo_url=CRATE_IO+"/demo",$scope.version_url=CRATE_IO+"/versions.json",$scope.menu_url=CRATE_IO+"/feed/menu.json",UdcSettings.availability.success(function(data){data.enabled!==!0&&($scope.blog_url=doNotTrackUrl($scope.blog_url),$scope.demo_url=doNotTrackUrl($scope.demo_url),$scope.version_url=doNotTrackUrl($scope.version_url),$scope.feed_url=doNotTrackUrl($scope.feed_url),$scope.menu_url=doNotTrackUrl($scope.menu_url)),$scope.numUnread=0,$scope.entries=[];var stableVersion;FeedService.parse($scope.version_url).success(function(response){response&&response.crate&&(stableVersion=response.crate)}),$scope.$watch(function(){return ClusterState.data},function(data){$scope.showUpdate=data.version&&stableVersion&&stableVersion>data.version.number,$scope.stableVersion=stableVersion,$scope.serverVersion=data.version?data.version.number:""},!0),$scope.showUpdate=!1,FeedService.parse($scope.menu_url).success(function(response){response&&response.data&&($scope.menu=response.data),UidLoader.load().success(function(uid){null!==uid&&data.enabled===!0&&$scope.menu.map(function(item){item.url=QueryStringAppender.append(item.url,"ajs_uid",uid.toString()),item.url=QueryStringAppender.append(item.url,"ajs_aid",uid.toString())})})})}),$scope.markAsRead=function(item){if("all"===item){for(var all=$scope.entries,i=0;i<all.length;i++)NotificationService.markAsRead(all[i].id);$scope.numUnread=0}else item&&(NotificationService.markAsRead(item.id),$scope.numUnread=Math.max(0,$scope.numUnread-1))},$scope.goToUrl=function(url){$window.open(url,"_blank")},$scope.menu=[{url:"https://crate.io/demo?utm_source=adminui&utm_medium=browser&utm_term=&utm_content=demolink&utm_campaign=newsfeed&ajs_event=clicked_demo_link",title:"Schedule a 1-ON-1 demo with a Crate.io engineer"}]}),angular.module("overview",["stats","checks","ngSanitize"]).factory("NullArray",function(){return{create:function(len){for(var res=new Array(len),i=0;i<res.length;i++)res[i]=null;return res}}}).controller("OverviewController",function($scope,$location,$log,$timeout,$interval,ClusterState,NullArray,ChecksService,SQLQuery){var lastUpdate=null,colorMap={good:"cr-panel--success",warning:"cr-panel--warning",critical:"cr-panel--danger","--":"cr-panel--default"},chartConf=[{key:"Load 1",color:"#5bd5f5",area:!0},{key:"Load 5",color:"#5d89fe"},{key:"Load 15",color:"#44e3a6"}];$scope.options={chart:{type:"lineChart",height:350,margin:{top:20,right:2,bottom:10,left:40},showXAxis:!1,showYAxis:!0,showLegend:!1,tooltip:{enabled:!1},yAxis:{tickFormat:function(d){return d3.format(".2f")(d)},axisLabelDistance:-10,showMaxMin:!1}}};var chartCache=[[],[],[]];$scope.available_data="--",$scope.records_unavailable="--",$scope.replicated_data="--",$scope.records_total="--",$scope.records_underreplicated="--",$scope.cluster_state="--",$scope.cluster_color_class="cr-panel--default",$scope.chart={data:[],toggleLoad:function(e,idx){$("#load-btn-"+idx).toggleClass("cr-radio-button__load__toggle--inactive"),$("#cluster-load .nv-series-"+idx).toggle()}},$scope.$watch(function(){return ChecksService},function(data){data.success===!0?$scope.checks=data.checks:$scope.checks={node_checks:[],cluster_check:[]}},!0),$scope.refresh=ChecksService.refresh;var removeFromArray=function(arr,obj){arr.splice(arr.indexOf(obj),1)},removeCheck=function(check){removeFromArray($scope.checks.node_checks,check)},drawGraph=function(history){chartCache=history;var data,len=history[0].length;if(len<ClusterState.HISTORY_LENGTH){var missing=ClusterState.HISTORY_LENGTH-len;data=[NullArray.create(missing),NullArray.create(missing),NullArray.create(missing)];for(var i=0;i<data.length;i++)data[i].push.apply(data[i],history[i])}else data=history;for(var l=0;l<data.length;l++)data[l]=data[l].map(function(load){return load>=0?load:null});$scope.chart.data=data.map(function(lineData,i){var line=angular.copy(chartConf[i]);return line.values=lineData.map(function(val,j){return{x:j,y:val}}),line})};$scope.dismissCheckByNode=function(node,check){var stmt="UPDATE sys.node_checks SET acknowledged = TRUE WHERE node_id = ? AND id = ?";SQLQuery.execute(stmt,[node.id,check.id],!1,!1,!1).success(function(){removeFromArray(check.nodes,node),0===check.nodes.length&&removeCheck(check)})},$scope.callback=function(){$scope.api.clearElement()},$scope.dismissCheck=function(check){var stmt="UPDATE sys.node_checks SET acknowledged = TRUE WHERE id = ?";SQLQuery.execute(stmt,[check.id],!1,!1,!1).success(function(){removeCheck(check)})},$scope.$watch(function(){return ClusterState.data},function(data){var now=(new Date).getTime();if(!(lastUpdate&&now-lastUpdate<100)){if(lastUpdate=now,$scope.cluster={name:data.name,state:data.status},$scope.cluster_color_class=colorMap[data.status],data.loadHistory[0].length>0&&drawGraph(data.loadHistory),!data.tables||!data.tables.length)return $scope.available_data=100,$scope.records_unavailable=0,$scope.replicated_data=100,$scope.records_total=0,$scope.records_total_with_replicas=0,void($scope.records_underreplicated=0);var tables=data.tables;$scope.records_underreplicated=tables.reduce(function(memo,tableInfo){return tableInfo.records_underreplicated+memo},0),$scope.records_unavailable=tables.reduce(function(memo,tableInfo){return tableInfo.records_unavailable+memo},0),$scope.records_total=tables.reduce(function(memo,tableInfo){return tableInfo.records_total+memo},0),$scope.records_total_with_replicas=tables.reduce(function(memo,tableInfo){return tableInfo.records_total_with_replicas+memo},0),$scope.records_total_with_replicas>0?($scope.replicated_data=Math.max(0,$scope.records_total_with_replicas-$scope.records_underreplicated)/$scope.records_total_with_replicas*100,$scope.available_data=Math.max(0,$scope.records_total_with_replicas-$scope.records_unavailable)/$scope.records_total_with_replicas*100):($scope.replicated_data=100,$scope.available_data=100)}},!0),$("[rel=tooltip]").tooltip({placement:"top"}),$scope.$on("$viewContentLoaded",function(){$timeout(function(){$scope.api.refresh()},100)}),$scope.$on("$destroy",function(){$scope.api.clearElement()})}),angular.module("console",["sql","datatypechecks"]).factory("KeywordObjectCreator",function(){return{create:function(arr){return arr.reduce(function(accumulator,currentValue){return accumulator[currentValue.toLowerCase()]=!0,accumulator},{})}}}).directive("console",function(SQLQuery,ColumnTypeCheck){return{restrict:"A",controller:["$scope","$translate",function($scope,$translate){var self=this,inputScope=null,statement="",displayedErrorTraceHint="1"===localStorage.getItem("crate.console.displayed_error_trace_hint");$scope.showOptions=!1,self.recentQueries=[],$scope.showErrorTrace="1"===localStorage.getItem("crate.console.error_trace"),$scope.formatResults="1"===(localStorage.getItem("crate.console.format_results")||"1"),$scope.error={hide:!0,message:"",error_trace:""},$scope.info={hide:!0,message:""},self.setInputScope=function(scope){inputScope=scope},$scope.storeInLocalStorageChanged=function(){localStorage.setItem("crate.console.store_queries",$scope.useLocalStorage===!0?"1":"0")},$scope.showErrorTraceChanged=function(){localStorage.setItem("crate.console.error_trace",$scope.showErrorTrace===!0?"1":"0")},$scope.formatReturnedResults=function(){localStorage.setItem("crate.console.format_results",$scope.formatResults===!0?"1":"0")};var getRecentQueriesFromLocalStorage=function(){var queryList=localStorage.getItem("crate.console.query_list");self.recentQueries=queryList?JSON.parse(queryList):[]},updateRecentQueries=function(stmt){$scope.useLocalStorage&&getRecentQueriesFromLocalStorage(),self.recentQueries[self.recentQueries.length-1]!==stmt&&self.recentQueries.push(stmt+";"),$scope.useLocalStorage&&localStorage.setItem("crate.console.query_list",JSON.stringify(self.recentQueries)),inputScope.recentCursor=-1};$scope.hide=function(item){item.hide=!0,item.message=""},$scope.toggleOptions=function(){$scope.showOptions=!$scope.showOptions},$scope.clearLocalStorage=function(){$translate(["CONSOLE.CLEAR_HISTORY_MSG","CONSOLE.CLEAR_HISTORY_MSG_PLURAL"]).then(function(i18n){var history=JSON.parse(localStorage.getItem("crate.console.query_list")||"[]");localStorage.setItem("crate.console.query_list",JSON.stringify([])),inputScope.recentCursor=0,self.recentQueries=[];var msg=history.length?0:history.length+" ";msg+=0===history.length||1===history.length?i18n["CONSOLE.CLEAR_HISTORY_MSG"]:i18n["CONSOLE.CLEAR_HISTORY_MSG_PLURAL"],$scope.info.message=msg,$scope.info.hide=!1})},$scope.ColumnTypeCheck=ColumnTypeCheck,$scope.loadMoreRows=function(amount){$scope.limitToAmount+=amount};var doStoreQueries=localStorage.getItem("crate.console.store_queries")||"1";$scope.useLocalStorage=!!parseInt(doStoreQueries),getRecentQueriesFromLocalStorage(),self.execute=function(sql){$scope.renderTable=!1;var stmt=sql.replace(/^\s+|\s+$/g,"");""!==stmt&&(stmt=stmt.replace(/([^;]);+$/,"$1"),stmt.match(/^\s*select\s/gi)&&!stmt.match(/limit\s+\d+/gi)&&(stmt+=" limit 100"),updateRecentQueries(stmt),$scope.loading=!0,$("#console-options").slideUp(),SQLQuery.execute(stmt,{},$scope.showErrorTrace,!0,!0).success(function(sqlQuery){$scope.loading=!1,$scope.error.hide=!0,$scope.error.message="",$scope.error.error_trace="",$scope.info.hide=!0,$scope.info.message="",$scope.renderTable=!0,$scope.resultHeaders=[];for(var i=0;i<sqlQuery.cols.length;i++)$scope.resultHeaders.push(sqlQuery.cols[i]);for($scope.resultHeaderTypes=[],i=0;i<sqlQuery.col_types.length;i++)$scope.resultHeaderTypes.push(sqlQuery.col_types[i]);$scope.rows=sqlQuery.rows,$scope.limitToAmount=0,$scope.loadMoreRows(100),$scope.status=sqlQuery.status(),$scope.statement=stmt+";",inputScope.updateInput($scope.statement)}).error(function(sqlQuery){$scope.loading=!1,$scope.error.hide=!1,$scope.renderTable=!1,$scope.error=sqlQuery.error,$scope.showErrorTrace||displayedErrorTraceHint||(displayedErrorTraceHint=!0,localStorage.setItem("crate.console.displayed_error_trace_hint","1")),$scope.status=sqlQuery.status(),$scope.rows=[],$scope.resultHeaders=[]}))},self.updateStatement=function(stmt){statement=stmt||""},$scope.execute=function(){self.execute(statement)}}]}}).directive("cli",function($timeout,KeywordObjectCreator){return{restrict:"E",transclude:!0,templateUrl:"static/views/editor.html",scope:{mimeType:"=",theme:"="},require:"^console",link:function($scope,element,attrs,$console){var statement="",typedStatement="",input=$("textarea",element)[0];CodeMirror.defineMIME("text/x-cratedb",{name:"sql",keywords:KeywordObjectCreator.create(["abs","absolute","action","add","after","alias","all","allocate","alter","always","analyzer","and","any","are","array","array_agg","array_max_cardinality","as","asc","asensitive","assertion","asymmetric","at","atomic","authorization","avg","before","begin","begin_frame","begin_partition","between","bigint","binary","bit","bit_length","blob","boolean","both","breadth","by","byte","call","called","cardinality","cascade","cascaded","case","cast","catalog","catalogs","ceil","ceiling","char","char_filters","char_length","character","character_length","check","clob","close","clustered","coalesce","collate","collation","collect","column","columns","commit","condition","connect","connection","constraint","constraints","constructor","contains","continue","convert","copy","corr","corresponding","count","covar_pop","covar_samp","create","cross","cube","cume_dist","current","current_catalog","current_date","current_path","current_role","current_row","current_schema","current_time","current_timestamp","current_user","cursor","cycle","data","date","day","deallocate","dec","decimal","declare","default","deferrable","deferred","delete","deny","dense_rank","depth","deref","desc","describe","descriptor","deterministic","diagnostics","directory","disconnect","distinct","distributed","do","domain","double","drop","duplicate","dynamic","each","element","else","elseif","end","end_exec","end_frame","end_partition","equals","escape","every","except","exception","exec","execute","exists","exit","explain","extends","external","extract","false","fetch","filter","first","first_value","float","for","foreign","format","found","frame_row","free","from","full","fulltext","function","functions","fusion","general","generated","geo_point","geo_shape","get","global","go","goto","grant","group","grouping","groups","handler","having","hold","hour","identity","if","ignored","immediate","in","index","indicator","initially","inner","inout","input","insensitive","insert","int","integer","intersect","intersection","interval","into","ip","is","isolation","iterate","join","key","kill","language","large","last","last_value","lateral","lead","leading","leave","left","level","like","like_regex","limit","ln","local","localtime","localtimestamp","locator","long","loop","lower","map","match","max","member","merge","method","min","minute","mod","modifies","module","month","multiset","names","national","natural","nchar","nclob","new","next","no","none","normalize","not","nth_value","ntile","null","nullif","nulls","numeric","object","octet_length","of","off","offset","old","on","only","open","optimize","option","or","order","ordinality","out","outer","output","over","overlaps","overlay","pad","parameter","partial","partition","partitioned","partitions","path","percent","percent_rank","percentile_cont","percentile_disc","period","persistent","plain","portion","position","position_regex","power","precedes","preceding","precision","prepare","preserve","primary","primary key","prior","privileges","procedure","public","range","rank","read","reads","real","recursive","ref","references","referencing","refresh","regr_avgx","regr_avgy","regr_count","regr_intercept","regr_r2","regr_slope","regr_sxx","regr_sxyregr_syy","relative","release","rename","repeat","repository","reset","resignal","restore","restrict","result","return","returns","revoke","right","role","rollback","rollup","routine","row","row_number","rows","savepoint","schema","schemas","scope","scroll","search","second","section","select","sensitive","session","session_user","set","sets","shards","short","show","signal","similar","size","smallint","snapshot","some","space","specific","specifictype","sql","sqlcode","sqlerror","sqlexception","sqlstate","sqlwarning","sqrt","start","state","static","stddev_pop","stddev_samp","stratify","stratify","strict","string","submultiset","substring","substring_regex","succeedsblob","sum","symmetric","system","system_time","system_user","table","tables","tablesample","temporary","text","then","time","timestamp","timezone_hour","timezone_minute","to","token_filters","tokenizer","trailing","transaction","transient","translate","translate_regex","translation","treat","trigger","trim","trim_array","true","truncate","try_cast","type","uescape","unbounded","under","undo","union","unique","unknown","unnest","until","update","upper","usage","user","using","value","value_of","values","var_pop","var_samp","varbinary","varchar","varying","versioning","view","when","whenever","where","while","width_bucket","window","with","within","without","work","write","year","zone"]),operatorChars:/^[*+\-%<>!=~]/});var editor=CodeMirror.fromTextArea(input,{mode:attrs.mimeType,theme:attrs.theme,lineWrapping:!0});editor.on("change",function(instance){statement=instance.getValue(),$console.updateStatement(statement)});var selectStatementInput=function(stmt){stmt&&editor.setValue(stmt),$timeout(function(){editor.execCommand("selectAll")},10)},getRecentQueriesIndex=function(queryCount,recentCursor){return queryCount+recentCursor>0?queryCount+recentCursor:0};editor.on("keydown",function(instance,event){var cursorPos=event.target.selectionStart,queryCount=$console.recentQueries.length,cursor=instance.getCursor(),selection=instance.getSelection();event.shiftKey||38!==event.keyCode?event.shiftKey||40!==event.keyCode?13===event.keyCode&&event.shiftKey?(event.preventDefault(),$console.execute(statement),typedStatement=""):$scope.recentCursor=0:(cursorPos>=event.target.textLength||0===cursorPos&&event.target.selectionEnd===statement.length)&&queryCount+$scope.recentCursor<queryCount&&($scope.recentCursor++,statement=$console.recentQueries[getRecentQueriesIndex(queryCount,$scope.recentCursor)]||typedStatement,selectStatementInput(statement)):(0===cursor.ch&&0===cursor.line||0===cursor.line&&selection===statement)&&(0===$scope.recentCursor&&(typedStatement=statement),$scope.recentCursor--,statement=$console.recentQueries[getRecentQueriesIndex(queryCount,$scope.recentCursor)]||"",selectStatementInput(statement))}),$console.setInputScope($scope),$scope.recentCursor=0,$scope.updateInput=function(stmt){selectStatementInput(stmt)}}}}).directive("lazyLoadScroll",function(){return{restrict:"A",link:function(scope,element,attrs){var e=element[0];$(window).scroll(function(){this.pageYOffset+this.innerHeight>e.scrollHeight&&scope.$apply(attrs.lazyLoadScroll)})}}}).directive("formattedArray",function(ObjectTypeCheck){return{restrict:"E",scope:{array:"=",typesarray:"=",expand:"="},templateUrl:"static/views/formatted-array-template.html",link:function(scope){scope.isExpanded=scope.expand,scope.ObjectTypeCheck=ObjectTypeCheck,scope.getArrayLength=function(){return scope.array.length},scope.formatArrayindex=function(index){return index+1},scope.getArrayType=function(){return 101==scope.typesarray[0]?"Set":"Array"},scope.toggleExpand=function(){scope.isExpanded=!scope.isExpanded}}}}).directive("formattedObject",function(ObjectTypeCheck){return{restrict:"E",scope:{object:"=",expand:"="},templateUrl:"static/views/formatted-object-template.html",link:function(scope){scope.isExpanded=scope.expand,scope.ObjectTypeCheck=ObjectTypeCheck,scope.getKeys=function(){return Object.keys(scope.object)},scope.getField=function(key){return scope.object[key]},scope.toggleExpand=function(){scope.isExpanded=!scope.isExpanded}}}}).controller("ConsoleController",function(){}),angular.module("tables",["stats","sql","common","tableinfo"]).provider("TabNavigationInfo",function(){this.collapsed=[!1,!0],this.$get=function(){var collapsed=this.collapsed;return{collapsed:collapsed,toggleIndex:function(index){collapsed[index]=!collapsed[index]},collapseIndex:function(index){collapsed[index]=!0},unCollapseIndex:function(index){collapsed[index]=!1}}}}).factory("PartitionsTableController",function(){return function(){this.data=[],this.sort={col:"partition_ident",desc:!1},this.setPartitions=function(partitions){this.data=partitions},this.sortByColumn=function(col){this.sort.col===col?this.sort.desc=!this.sort.desc:(this.sort.col=col,this.sort.desc=!1)},this.selected=function(col){return col===this.sort.col?this.sort.desc?"fa fa-chevron-down":"fa fa-chevron-up":""}}}).controller("TableDetailController",function($scope,$location,$log,$timeout,$route,SQLQuery,queryResultToObjects,roundWithUnitFilter,bytesFilter,TableList,TableInfo,TabNavigationInfo,PartitionsTableController){var scopeWatcher=null,activeRequests={},colorMapLabel={good:"",warning:"label-warning",critical:"label-danger","--":""},colorMapCell={good:"cr-cell--success",warning:"cr-cell--warning",critical:"cr-cell--danger","--":""},placeholder={name:"",summary:"",health:"--",health_label_class:"",health_panel_class:"",health_cell_class:"",records_total:0,records_replicated:0,records_underreplicated:0,records_unavailable:0,shards_configured:0,shards_started:0,shards_missing:0,shards_underreplicated:0,replicas_configured:"0",size:0,recovery_percent:0},requestId=function(){return"r-"+(new Date).getTime()+"-"+Math.floor(1e3*Math.random())},cancelRequests=function(){for(var k in activeRequests){var request=activeRequests[k];request.cancel()}activeRequests={}},filterByIdent=function(ident){return function(item){return item.partition_ident===ident}},render=function(tableSchema,tableName){$scope.ptCtlr=new PartitionsTableController,$scope.nothingSelected=!1,$scope.renderSiderbar=!0,$scope.isParted=!1;var update=function(success,partitions,cancelled){cancelled||($scope.ptCtlr.data=partitions,$scope.isParted=!0,$scope.renderPartitions=success,$scope.renderSchema=!0)},fetchPartitions=function(){if(tableName&&tableSchema){var shardStmt='SELECT partition_ident, routing_state, state, relocating_node, "primary", SUM(num_docs), AVG(num_docs), COUNT(*), SUM(size) FROM sys.shards WHERE schema_name = ? AND table_name = ? AND partition_ident != \'\' GROUP BY partition_ident, routing_state, state, relocating_node, "primary"',r1=requestId(),q1=SQLQuery.execute(shardStmt,[tableSchema,tableName],!1,!1,!1).success(function(shardQuery){if("undefined"!=typeof activeRequests[r1]){var tablePartitionStmt="SELECT partition_ident, number_of_shards, number_of_replicas, values FROM information_schema.table_partitions WHERE schema_name = ? AND table_name = ?",r2=requestId(),q2=SQLQuery.execute(tablePartitionStmt,[tableSchema,tableName],!1,!1,!1).success(function(tablePartitionQuery){if("undefined"!=typeof activeRequests[r2]){for(var partitions=[],shardResult=queryResultToObjects(shardQuery,["partition_ident","routing_state","state","relocating_node","primary","sum_docs","avg_docs","count","size"]),partitionResult=queryResultToObjects(tablePartitionQuery,["partition_ident","number_of_shards","number_of_replicas","values"]),idents=shardResult.reduce(function(memo,obj){var ident=obj.partition_ident;return memo.indexOf(ident)===-1&&memo.push(ident),memo},[]),i=0;i<idents.length;i++){var ident=idents[i],shardInfoForPartition=shardResult.filter(filterByIdent(ident)),confInfoForPartition=partitionResult.filter(filterByIdent(ident));if(1===confInfoForPartition.length){var info=new TableInfo(shardInfoForPartition,confInfoForPartition[0].number_of_shards),o=info.asObject();o.partition_values=confInfoForPartition[0].values,o.partition_ident=ident,o.replicas_configured=confInfoForPartition[0].number_of_replicas,o.health_label_class=colorMapLabel[o.health],o.health_cell_class=colorMapCell[o.health],partitions.push(o)}}update(!0,partitions,"undefined"==typeof activeRequests[r2]),delete activeRequests[r2]}}).error(function(){update(!1,[],"undefined"==typeof activeRequests[r2]),delete activeRequests[r2]});delete activeRequests[r1],activeRequests[r2]=q2}}).error(function(){update(!1,[],"undefined"==typeof activeRequests[r1]),delete activeRequests[r1]});activeRequests[r1]=q1}};if(tableName&&tableSchema){var tableStmt="SELECT column_name, data_type FROM information_schema.columns WHERE table_schema = ? AND table_name = ?";SQLQuery.execute(tableStmt,[tableSchema,tableName],!1,!1,!1).success(function(query){$scope.schemaHeaders=query.cols,$scope.schemaRows=query.rows,$scope.renderSchema=!0}).error(function(){$scope.renderSchema=!1})}scopeWatcher=$scope.$watch(function(){return TableList.data},function(data){var tables=data.tables;if(tables.length>0){var current=tables.filter(function(item){return item.name===tableName&&item.table_schema===tableSchema});current=current.length?current[0]:tables[0],$scope.table=current,$scope.table_label=current.name,"blob"==current.table_schema?$scope.table_label="BLOB: "+current.name:"doc"!=current.table_schema&&($scope.table_label=current.table_schema+"."+current.name),$scope.nothingSelected=null===current,$scope.renderSidebar=!0,$scope.table.partitioned&&fetchPartitions();var expectedUrl="/tables/"+current.table_schema+"/"+current.name;$location.$$url!==expectedUrl&&$location.url(expectedUrl)}else $scope.table=placeholder,$scope.table_label=placeholder.name,$scope.nothingSelected=!1,$scope.renderSidebar=!1,$scope.renderSchema=!1,$scope.renderPartitions=!1;$scope.nr_of_tables=tables.length},!0),$scope.$on("$destroy",function(){cancelRequests(),scopeWatcher&&(scopeWatcher(),scopeWatcher=null)}),$scope.table=null,$scope.renderSidebar=!0,$scope.renderSchema=!1,$scope.renderPartitions=!1};$("[rel=tooltip]").tooltip({placement:"top"}),$scope.toggleSidebar=function(){$("#page-viewport").toggleClass("show-sidebar"),
$(".menu-toggle i.fa").toggleClass("fa-angle-double-right").toggleClass("fa-angle-double-left")};var lastRoute=$route.current;$scope.$on("$locationChangeSuccess",function(){if("TableDetailController"===$route.current.$$route.controller){scopeWatcher&&(scopeWatcher(),scopeWatcher=null),cancelRequests();var params=$route.current.params;render(params.table_schema,params.table_name),$route.current=lastRoute,$route.current.params=params}}),render($route.current.params.table_schema,$route.current.params.table_name)}).controller("TableListController",function($scope,$route,TableList,TabNavigationInfo){var filterBySchemaName=function(name){return function(item){return item.table_schema==name}};$scope.collapsed=!0;var render=function(tableSchema,tableName){$scope.renderSidebar=!0,$scope.$watch(function(){return TableList.data},function(data){var tables=data.tables,hasTables=tables.length>0;if($scope.renderSidebar=hasTables,hasTables){tableName&&tableSchema||(tableName=tables[0].name,tableSchema=tables[0].table_schema);var idx,name,customSchemas=[];for(idx in tables)name=tables[idx].table_schema,"doc"==name||"blob"==name||customSchemas.indexOf(name)>-1||customSchemas.push(name);$scope.tables=[],$scope.tables.push({display_name:"Doc",tables:tables.filter(function(item){return"doc"==item.table_schema}),table_schema:"doc"});for(idx in customSchemas)name=customSchemas[idx],$scope.tables.push({display_name:name,tables:tables.filter(filterBySchemaName(name)),table_schema:name});$scope.tables.push({display_name:"Blob",tables:tables.filter(function(item){return"blob"==item.table_schema}),table_schema:"blob"})}else $scope.tables=[]},!0),$scope.isActive=function(table_schema,table_name){return table_name===tableName&&table_schema===tableSchema},$scope.startedShardsError=function(table){return(!table.partitioned||0!==table.shards_started)&&table.shards_started<table.shards_configured},$scope.toggleElements=function(index){$("#nav-tabs-"+index).collapse("toggle"),$("#nav-tabs-header-"+index+" i.fa").toggleClass("fa-caret-down").toggleClass("fa-caret-right"),TabNavigationInfo.toggleIndex(index)},$scope.isCollapsed=function(index){return TabNavigationInfo.collapsed[index]};var table;$scope.collapseAll=function(){for(table in $scope.tables)$("#nav-tabs-"+table).collapse("toggle"),$("#nav-tabs-header-"+table+" i.fa").toggleClass("fa-caret-down").toggleClass("fa-caret-right"),TabNavigationInfo.collapseIndex(table);$scope.collapsed=!0},$scope.unCollapseAll=function(){for(table in $scope.tables)$("#nav-tabs-"+table).collapse("toggle"),$("#nav-tabs-header-"+table+" i.fa").toggleClass("fa-caret-down").toggleClass("fa-caret-right"),TabNavigationInfo.unCollapseIndex(table);$scope.collapsed=!1}};$scope.$on("$locationChangeSuccess",function(){if("TableDetailController"===$route.current.$$route.controller){var params=$route.current.params;render(params.table_schema,params.table_name)}}),render($route.current.params.table_schema,$route.current.params.table_name)}),angular.module("cluster",["stats","sql","common","nodeinfo"]).controller("NodeListController",function($scope,$route,ClusterState,prepareNodeList,NodeListInfo,compareByHealth,$location){$scope.nodes=[],$scope.selected=null,$scope.goToPath=function(id){$location.path("/nodes/"+id)};var currentWatcher=null,version=null,nodeId=null,render=function(_nodeId){nodeId=_nodeId,currentWatcher&&currentWatcher(),currentWatcher=$scope.$watch(function(){return ClusterState.data},function(data){var cluster=angular.copy(data.cluster);version=data.version;var showSidebar=cluster.length>0;$scope.renderSidebar=showSidebar;var nodeList=prepareNodeList(cluster,data.master_node);if(showSidebar){nodeList=nodeList.sort(compareByHealth);var nodeIds=nodeList.map(function(obj){return obj.id});if(nodeId&&nodeIds.indexOf(nodeId)>=0){var selectedNode=nodeList.filter(function(node){return node.id===nodeId});$scope.selected=selectedNode.length?selectedNode[0]:nodeList[0]}else $scope.selected=nodeList[0],nodeId=nodeList[0].id}else $scope.selected=null;$scope.nodes=nodeList},!0)};$scope.sort=NodeListInfo.sort,$scope.sortBy=NodeListInfo.sortBy,$scope.sortClass=NodeListInfo.sortClass,$scope.isActive=function(node){return node.id===nodeId},$scope.isSameVersion=function(nodeVersion){return!version||nodeVersion.build_hash===version.hash},$scope.$on("$locationChangeSuccess",function(){"NodeDetailController"===$route.current.$$route.controller&&render($route.current.params.node_id)}),render($route.current.params.node_id)}).controller("NodeDetailController",function($scope,$interval,$route,$http,$filter,$location,ClusterState,prepareNodeList,compareByHealth){var byteFormatFunction=$filter("bytes");$scope.node=null;var options={chart:{type:"multiBarHorizontalChart",height:20,margin:{left:0,top:0,bottom:0,right:0},forceY:[0,100],showControls:!1,showValues:!1,duration:500,showLegend:!1,stacked:!0,showXaxis:!1,showYaxis:!1,x:function(d){return d.label},y:function(d){return d.value},xAxis:{showMaxMin:!1},yAxis:{}}};$scope.percent_options=angular.copy(options),$scope.percent_options.chart.yAxis={tickFormat:function(d){return String(d)+"%"}},$scope.bytes_options=angular.copy(options),$scope.bytes_options.chart.yAxis={tickFormat:function(d){return byteFormatFunction(d,2)}};var empty={name:"",id:"",summary:[],health:"--",health_label_class:"",health_panel_class:"",hostname:"--",address:"",version:{number:"--",build_hash:"",build_snapshot:!1},heap:{total:0,free:0,used:0,used_percent:0,free_percent:0},fs:{total:0,available:0,used:0,available_percent:0,used_percent:0},shardInfo:{started:-1,initializing:-1,reallocating:-1,postrecovery:-1}},COLORS={used:"#5bd5f5",free:"#e2e2e2"},version=null,currentWatcher=null,aggregateDataDiskUtilisation=function(node){var fs={total:0,available:0,used:0,available_percent:0,used_percent:0};if(node.fs.data){for(var dataDisks=[],k=0;k<node.fs.data.length;k++)dataDisks.push(node.fs.data[k].dev);for(var j=0;j<node.fs.disks.length;j++){var disk=node.fs.disks[j],isDataDisk=dataDisks.indexOf(disk.dev)>-1;isDataDisk&&(fs.total+=disk.size,fs.available+=disk.available,fs.used+=disk.used)}fs.available_percent=100*fs.available/fs.total,fs.used_percent=100*fs.used/fs.total}return fs},getShardsCountPerState=function(shardInfo,state){return shardInfo.filter(function(shard){return shard.state===state}).reduce(function(acc,table){return acc+table.count},0)},drawGraph=function(node){$scope.cpuData=[{key:"System",values:[{label:"CPU",value:node.cpu.system}],color:COLORS.used},{key:"User",values:[{label:"CPU",value:node.cpu.user}],color:"#5d89fe"},{key:"Idle",values:[{label:"CPU",value:Math.max(0,100-node.cpu.system-node.cpu.user-node.cpu.stolen)}],color:COLORS.free},{key:"Stolen",values:[{label:"CPU",value:node.cpu.stolen}],color:"#f6bb41"}],$scope.heapData=[{key:"Used",values:[{label:"HEAP",value:node.heap.used}],color:COLORS.used},{key:"Free",values:[{label:"HEAP",value:node.heap.max-node.heap.used}],color:COLORS.free}],$scope.diskUsageData=[{key:"Used",values:[{label:"Disk Usage",value:node.fs.used}],color:COLORS.used},{key:"Free",values:[{label:"Disk Usage",value:node.fs.available}],color:COLORS.free}],$scope.processCpuData=[{key:"Used",values:[{label:"Process CPU",value:Math.min(100,node.proc_cpu.percent/node.num_cores)}],color:COLORS.used},{key:"Idle",values:[{label:"Process CPU",value:Math.max(100,node.proc_cpu.percent/node.num_cores)}],color:COLORS.free}]},render=function(nodeId){currentWatcher&&currentWatcher(),currentWatcher=$scope.$watch(function(){return ClusterState.data},function(data){for(var cluster=angular.copy(data.cluster),shards=angular.copy(data.shards),i=0;i<cluster.length;i++)cluster[i].fs=aggregateDataDiskUtilisation(cluster[i]);version=data.version;var showSidebar=cluster.length>0;$scope.renderSidebar=showSidebar;var nodeList=prepareNodeList(cluster,data.master_node);if(showSidebar){nodeList=nodeList.sort(compareByHealth);var currentNode,nodeIds=nodeList.map(function(obj){return obj.id});if(nodeId&&nodeIds.indexOf(nodeId)>=0){var selectedNode=nodeList.filter(function(node){return node.id==nodeId});currentNode=selectedNode.length?selectedNode[0]:nodeList[0]}else currentNode=nodeList[0];var expectedUrl="/nodes/"+currentNode.id;$location.$$url!==expectedUrl?$location.url(expectedUrl):($scope.node=currentNode,drawGraph($scope.node))}else $scope.node=angular.copy(empty);if($scope.node&&shards&&shards.length){var shardInfoPerNode=shards.filter(function(shard){return shard.node_id===$scope.node.id});$scope.shardInfo={started:getShardsCountPerState(shardInfoPerNode,"STARTED"),initializing:getShardsCountPerState(shardInfoPerNode,"INITIALIZING"),reallocating:getShardsCountPerState(shardInfoPerNode,"REALLOCATING"),postrecovery:getShardsCountPerState(shardInfoPerNode,"POST_RECOVERY")}}},!0)};$scope.toolTipUsedPercentFunction=function(){return function(key,x,y){return"<p>"+key+"<br /><b>"+y+"%</b></p>"}},$scope.toolTipUsedBytesFunction=function(){return function(key,x,y){return"<p>"+key+"<br /><b>"+y+"</b></p>"}},$scope.yAxisByteFormatFunction=function(){return function(d){return byteFormatFunction(d,2)}},$("[rel=tooltip]").tooltip({placement:"top"}),$scope.toggleSidebar=function(){$("#page-viewport").toggleClass("show-sidebar"),$(".menu-toggle i.fa").toggleClass("fa-angle-double-right").toggleClass("fa-angle-double-left")},$scope.isSameVersion=function(nodeVersion){return!version||nodeVersion.build_hash===version.hash};var lastRoute=$route.current;$scope.$on("$locationChangeSuccess",function(){if("NodeDetailController"===$route.current.$$route.controller){var params=$route.current.params;render(params.node_id),$route.current=lastRoute,$route.current.params=params}}),render($route.current.params.node_id)}),angular.module("common").filter("capitalize",function(){return function(input){return input.substring(0,1).toUpperCase()+input.substring(1)}}).filter("severityClass",function(){return function(severity){switch(severity){case 1:return"severity--info";case 2:return"severity--warning";case 3:return"severity--danger";default:return"severity--info"}}}).filter("severityText",function($filter){return function(severity){var translate=$filter("translate");switch(severity){case 1:return translate("OVERVIEW.INFO");case 2:return translate("OVERVIEW.WARNING");case 3:return translate("OVERVIEW.CRITICAL");default:return translate("OVERVIEW.INF")}}}).filter("healthPanelClass",function(){return function(health){switch(health){case"good":return"cr-panel--success";case"warning":return"cr-panel--warning";case"danger":return"cr-panel--danger";case"--":return"cr-panel--default";default:return"cr-panel--default"}}}).filter("queryStatusClass",function(){return function(status){return void 0===status?"":status.indexOf("OK")!==-1?"query-status--ok":status.indexOf("ERROR")!==-1?"query-status--error":""}}).filter("languageFilter",function(){return function(langkey){switch(langkey){case"en":return"English";case"de":return"Deutsch";case"es":return"EspaÃ±ol";default:return"Auto"}}}).filter("columnTypeClass",function(){return function(colType){switch(colType){case 2:case 6:case 7:case 8:case 9:case 10:return"number";case 4:case 5:return"string";case 3:return"boolean";case 11:case 13:case 14:return"object"}}}).filter("formatTimestamp",function(){return function(timestamp){return new Date(timestamp).toISOString()}}).filter("urlEncodedJson",function(){return function(json){return encodeURIComponent(JSON.stringify(json))}}),angular.module("common").filter("floor",function($filter){var f=$filter("number");return function(value,fraction){var n=Math.pow(10,fraction);return f(Math.floor(value*n)/n,fraction)}}).filter("roundWithUnit",function($filter,$sce){var f=$filter("number");return function(input,fraction){var res="";return"undefined"==typeof fraction&&(fraction=3),res=Math.abs(Number(input))>=1e9?f(Math.abs(Number(input))/1e9,fraction)+"Â Billion":Math.abs(Number(input))>=1e6?f(Math.abs(Number(input))/1e6,fraction)+"Â Million":f(Math.abs(Number(input)),0),$sce.trustAsHtml(res)}}).filter("bytes",function($sce){var units=["B","KB","MB","GB","TB","PB"];return function(bytes,precision){if(isNaN(parseFloat(bytes))||!isFinite(bytes))return"-";if(0===bytes)return"0Â B";"undefined"==typeof precision&&(precision=1);var number=Math.floor(Math.log(bytes)/Math.log(1024)),res=(bytes/Math.pow(1024,Math.floor(number))).toFixed(precision)+"Â "+units[number];return $sce.trustAsHtml(res)}});